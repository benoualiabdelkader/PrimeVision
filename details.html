<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeVision - التفاصيل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar Navigation -->
    <aside class="w-full md:w-64 bg-slate-900/80 backdrop-blur-sm border-l border-slate-800 p-4 md:p-6 fixed md:relative bottom-0 md:bottom-auto z-40 md:z-auto md:flex flex-col flex-shrink-0" id="sidebar">
        <a href="index.html" id="logo-link" class="flex items-center gap-2 text-2xl font-bold text-white mb-8 hidden md:flex">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-sky-400"><path d="M4.5 4.5a3 3 0 00-3 3v9a3 3 0 003 3h9a3 3 0 003-3v-1.1l5.555 3.056A1.5 1.5 0 0024 18.382V5.618a1.5 1.5 0 00-2.445-1.222L16.5 7.45V7.5a3 3 0 00-3-3h-9z"></path></svg>
            PrimeVision
        </a>
        <nav class="flex md:flex-col justify-around md:justify-start md:gap-2">
            <a href="index.html" class="sidebar-link flex flex-col md:flex-row items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors">
                <i data-lucide="home" class="w-5 h-5 text-slate-400"></i><span class="text-sm md:text-base">الرئيسية</span>
            </a>
            <a href="search.html?type=movie" class="sidebar-link flex flex-col md:flex-row items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors">
                <i data-lucide="film" class="w-5 h-5 text-slate-400"></i><span class="text-sm md:text-base">أفلام</span>
            </a>
            <a href="search.html?type=tv" class="sidebar-link flex flex-col md:flex-row items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors">
                <i data-lucide="tv" class="w-5 h-5 text-slate-400"></i><span class="text-sm md:text-base">مسلسلات</span>
            </a>
            <a href="favorites.html" class="sidebar-link flex flex-col md:flex-row items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors">
                <i data-lucide="heart" class="w-5 h-5 text-slate-400"></i><span class="text-sm md:text-base">المفضلة</span>
            </a>
            <a href="favorites.html?tab=watchlist" class="sidebar-link flex flex-col md:flex-row items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors">
                <i data-lucide="list-video" class="w-5 h-5 text-slate-400"></i><span class="text-sm md:text-base">قائمة المشاهدة</span>
            </a>
        </nav>
        <div class="mt-auto hidden md:block">
            <button id="theme-toggle" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors">
                <i id="theme-icon" data-lucide="sun" class="w-5 h-5 text-slate-400"></i><span id="theme-text">الوضع الفاتح</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 pb-20 md:pb-0 overflow-y-auto">
        <!-- Header -->
        <header class="nav-header sticky top-0 z-30 p-4 flex items-center justify-between gap-4">
             <div class="flex items-center gap-4">
                <button onclick="history.back()" class="p-2 rounded-full hover:bg-slate-700">
                    <i data-lucide="arrow-right" class="w-5 h-5 text-slate-400"></i>
                </button>
                <button id="user-btn" class="flex items-center gap-2" onclick="window.location.href='profile.html'">
                    <img src="./images/default-avatar.jpg" alt="User" class="w-8 h-8 rounded-full user-avatar">
                    <span class="username-display hidden md:inline">زائر</span>
                </button>
                 <button id="notification-btn" class="relative p-2 rounded-full hover:bg-slate-700">
                    <i data-lucide="bell" class="w-5 h-5 text-slate-400"></i>
                 </button>
            </div>
            <div class="flex-1 max-w-xl flex items-center gap-2">
                <form id="search-form" class="relative flex-1">
                    <input type="text" id="search-input" name="query" placeholder="ابحث عن أفلام، مسلسلات..." class="w-full bg-slate-800 border border-slate-700 rounded-full py-2 pr-10 pl-4 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                </form>
            </div>
            <a href="index.html" id="mobile-logo-link" class="flex md:hidden items-center gap-2 text-xl font-bold text-white">
                PrimeVision
            </a>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="p-4 md:p-6 lg:p-8"></div>
    </main>

    <!-- Scripts -->
    <script src="./js/app.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/favorites.js"></script>
    
    <script>
        // Details page specific functionality
        class DetailsPage {
            constructor() {
                this.API_KEY = '93f545a97aec858af4381e4008d9ce3c';
                this.BASE_URL = 'https://api.themoviedb.org/3';
                this.IMG_URL = 'https://image.tmdb.org/t/p/w500';
                this.BACKDROP_URL = 'https://image.tmdb.org/t/p/w1280';
                this.init();
            }

            init() {
                this.loadUserData();
                this.setupEventListeners();
                this.loadMovieDetails();
            }

            loadUserData() {
                const userJSON = localStorage.getItem('primevision_user');
                if (userJSON) {
                    try {
                        const userData = JSON.parse(userJSON);
                        this.user = userData.user;
                        this.favorites = userData.favorites || [];
                        this.watchlist = userData.watchlist || [];
                        this.reviews = userData.reviews || {};
                    } catch (e) {
                        this.user = null;
                        this.favorites = [];
                        this.watchlist = [];
                        this.reviews = {};
                    }
                } else {
                    this.user = null;
                    this.favorites = [];
                    this.watchlist = [];
                    this.reviews = {};
                }
                this.updateAuthUI();
            }

            updateAuthUI() {
                const usernameDisplays = document.querySelectorAll('.username-display');
                const userAvatars = document.querySelectorAll('.user-avatar');
                
                usernameDisplays.forEach(element => {
                    element.textContent = this.user ? this.user.username || this.user.name : 'زائر';
                });

                userAvatars.forEach(img => {
                    img.src = this.user ? (this.user.avatar || './images/default-avatar.jpg') : './images/default-avatar.jpg';
                });
            }

            setupEventListeners() {
                // Search form
                const searchForm = document.getElementById('search-form');
                if (searchForm) {
                    searchForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const query = document.getElementById('search-input').value.trim();
                        if (query) {
                            window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                        }
                    });
                }

                // Theme toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
            }

            toggleTheme() {
                const currentTheme = document.documentElement.classList.contains('light') ? 'light' : 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                this.applyTheme(newTheme);
            }

            applyTheme(theme) {
                document.documentElement.className = theme;
                localStorage.setItem('primevision_theme', theme);
                
                const themeIcon = document.getElementById('theme-icon');
                const themeText = document.getElementById('theme-text');
                
                if (theme === 'dark') {
                    if(themeIcon) themeIcon.setAttribute('data-lucide', 'moon');
                    if(themeText) themeText.textContent = 'الوضع المظلم';
                } else {
                    if(themeIcon) themeIcon.setAttribute('data-lucide', 'sun');
                    if(themeText) themeText.textContent = 'الوضع الفاتح';
                }
                lucide.createIcons();
            }

            async loadMovieDetails() {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                const type = urlParams.get('type') || 'movie';

                if (!id) {
                    this.showError('معرف العنصر مفقود');
                    return;
                }

                this.showLoading();

                try {
                    const [details, credits, videos, recommendations] = await Promise.all([
                        this.fetchFromTMDB(`${type}/${id}`),
                        this.fetchFromTMDB(`${type}/${id}/credits`),
                        this.fetchFromTMDB(`${type}/${id}/videos`),
                        this.fetchFromTMDB(`${type}/${id}/recommendations`)
                    ]);

                    if (details) {
                        this.renderDetails(details, credits, videos, recommendations, type);
                    } else {
                        this.showError('فشل في تحميل التفاصيل');
                    }
                } catch (error) {
                    this.showError('حدث خطأ أثناء تحميل التفاصيل');
                }
            }

            async fetchFromTMDB(endpoint, params = {}) {
                const url = new URL(`${this.BASE_URL}/${endpoint}`);
                url.searchParams.append('api_key', this.API_KEY);
                url.searchParams.append('language', 'ar-SA');
                
                Object.entries(params).forEach(([key, value]) => {
                    if (value !== null && value !== undefined && value !== '') {
                        url.searchParams.append(key, value);
                    }
                });
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            }

            renderDetails(details, credits, videos, recommendations, type) {
                const trailer = videos.results.find(video => video.type === 'Trailer' && video.site === 'YouTube');
                const isFavorite = this.favorites.some(fav => fav.id === details.id);
                const onWatchlist = this.watchlist.some(item => item.id === details.id);
                const userReview = this.reviews[details.id];

                const contentArea = document.getElementById('content-area');
                contentArea.innerHTML = `
                    <div class="fade-in">
                        <!-- Hero Section -->
                        <div class="relative rounded-2xl overflow-hidden mb-8">
                            <img src="${details.backdrop_path ? this.BACKDROP_URL + details.backdrop_path : './images/placeholder-backdrop.jpg'}" 
                                 alt="${details.title || details.name}" 
                                 class="w-full h-48 md:h-96 object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent"></div>
                            <div class="absolute bottom-6 left-6 right-6 text-white">
                                <h1 class="text-3xl md:text-5xl font-extrabold mb-4">${details.title || details.name}</h1>
                                <div class="flex flex-wrap items-center gap-4 text-slate-300 mb-4">
                                    <span class="text-lg">${(details.release_date || details.first_air_date || '').split('-')[0]}</span>
                                    <div class="flex items-center gap-1 text-yellow-400">
                                        <i data-lucide="star" class="w-5 h-5 fill-current"></i>
                                        <span class="text-lg font-bold">${details.vote_average.toFixed(1)}</span>
                                    </div>
                                    <span>${details.genres.map(g => g.name).join(' • ')}</span>
                                    ${details.runtime ? `<span>${details.runtime} دقيقة</span>` : ''}
                                </div>
                                <p class="max-w-3xl text-slate-300 hidden md:block">${details.overview}</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex items-center gap-4 mb-8">
                            ${trailer ? `
                                <button onclick="detailsPage.playTrailer('${trailer.key}')" 
                                        class="btn-primary flex items-center gap-2 text-lg px-6 py-3">
                                    <i data-lucide="play"></i> تشغيل المقطع الدعائي
                                </button>
                            ` : ''}
                            <button onclick="detailsPage.toggleFavorite(${details.id}, '${type}')" 
                                    class="p-3 rounded-full border-2 ${isFavorite ? 'bg-red-500 border-red-500' : 'border-slate-600'} hover:border-red-500 group">
                                <i data-lucide="heart" class="w-6 h-6 ${isFavorite ? 'fill-white text-white' : 'text-slate-400'} group-hover:text-red-500"></i>
                            </button>
                            <button onclick="detailsPage.toggleWatchlist(${details.id}, '${type}')" 
                                    class="p-3 rounded-full border-2 ${onWatchlist ? 'bg-sky-500 border-sky-500' : 'border-slate-600'} hover:border-sky-500 group">
                                <i data-lucide="plus" class="w-6 h-6 ${onWatchlist ? 'text-white' : 'text-slate-400'} group-hover:text-sky-500"></i>
                            </button>
                            <button onclick="detailsPage.shareContent('${details.title || details.name}')" 
                                    class="p-3 rounded-full border-2 border-slate-600 hover:border-green-500 group">
                                <i data-lucide="share-2" class="w-6 h-6 text-slate-400 group-hover:text-green-500"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Main Content -->
                            <div class="lg:col-span-2 space-y-8">
                                <!-- Overview -->
                                <section>
                                    <h2 class="text-2xl font-bold mb-4">نظرة عامة</h2>
                                    <p class="text-slate-300 leading-relaxed">${details.overview || 'لا يوجد وصف متاح'}</p>
                                </section>

                                <!-- Cast -->
                                ${credits.cast.length > 0 ? `
                                <section>
                                    <h2 class="text-2xl font-bold mb-4">طاقم العمل</h2>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                        ${credits.cast.slice(0, 10).map(actor => `
                                            <div class="text-center">
                                                <img src="${actor.profile_path ? this.IMG_URL + actor.profile_path : './images/placeholder-person.jpg'}" 
                                                     alt="${actor.name}" 
                                                     class="w-full aspect-square rounded-full object-cover mb-2">
                                                <h3 class="font-semibold text-sm">${actor.name}</h3>
                                                <p class="text-xs text-slate-400">${actor.character}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </section>
                                ` : ''}

                                <!-- User Review -->
                                <section>
                                    <h2 class="text-2xl font-bold mb-4">تقييمك</h2>
                                    ${userReview ? `
                                        <div class="bg-card p-6 rounded-lg">
                                            <div class="flex items-center gap-2 mb-3">
                                                ${Array(userReview.rating).fill(0).map(() => `<i data-lucide="star" class="w-5 h-5 text-yellow-400 fill-current"></i>`).join('')}
                                                ${Array(5 - userReview.rating).fill(0).map(() => `<i data-lucide="star" class="w-5 h-5 text-yellow-400"></i>`).join('')}
                                                <span class="text-sm text-muted mr-2">${userReview.rating}/5</span>
                                            </div>
                                            <p class="text-slate-300">${userReview.text}</p>
                                            <button onclick="detailsPage.deleteReview(${details.id})" 
                                                    class="text-red-400 hover:text-red-300 text-sm mt-3">
                                                حذف التقييم
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="bg-card p-6 rounded-lg">
                                            ${this.user ? `
                                                <form id="review-form" onsubmit="detailsPage.submitReview(event, ${details.id})">
                                                    <div class="flex items-center gap-1 mb-4">
                                                        <span class="text-sm font-medium mr-2">التقييم:</span>
                                                        <div class="rating-stars flex gap-1">
                                                            ${[1,2,3,4,5].map(star => `
                                                                <i data-lucide="star" 
                                                                   data-value="${star}" 
                                                                   class="w-6 h-6 text-yellow-400 cursor-pointer rating-star" 
                                                                   onclick="detailsPage.setRating(${star})"></i>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                    <textarea id="review-text" 
                                                              placeholder="اكتب مراجعتك..." 
                                                              class="form-input w-full mb-4" 
                                                              rows="3"></textarea>
                                                    <button type="submit" class="btn-primary">إرسال التقييم</button>
                                                </form>
                                            ` : `
                                                <p class="text-muted text-center">
                                                    <a href="login.html" class="text-primary hover:underline">سجل الدخول</a> 
                                                    لكتابة تقييم
                                                </p>
                                            `}
                                        </div>
                                    `}
                                </section>
                            </div>

                            <!-- Sidebar -->
                            <div class="space-y-6">
                                <!-- Details Info -->
                                <div class="bg-card p-6 rounded-lg">
                                    <h3 class="font-bold text-lg mb-4">معلومات إضافية</h3>
                                    <div class="space-y-3 text-sm">
                                        ${details.original_language ? `
                                            <div class="flex justify-between">
                                                <span class="text-muted">اللغة الأصلية:</span>
                                                <span>${details.original_language.toUpperCase()}</span>
                                            </div>
                                        ` : ''}
                                        ${details.budget ? `
                                            <div class="flex justify-between">
                                                <span class="text-muted">الميزانية:</span>
                                                <span>$${details.budget.toLocaleString()}</span>
                                            </div>
                                        ` : ''}
                                        ${details.revenue ? `
                                            <div class="flex justify-between">
                                                <span class="text-muted">الإيرادات:</span>
                                                <span>$${details.revenue.toLocaleString()}</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between">
                                            <span class="text-muted">عدد التقييمات:</span>
                                            <span>${details.vote_count.toLocaleString()}</span>
                                        </div>
                                        ${details.production_companies && details.production_companies.length > 0 ? `
                                            <div>
                                                <span class="text-muted block mb-2">شركات الإنتاج:</span>
                                                <div class="space-y-1">
                                                    ${details.production_companies.slice(0, 3).map(company => `
                                                        <div class="text-xs">${company.name}</div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Genres -->
                                ${details.genres && details.genres.length > 0 ? `
                                    <div class="bg-card p-6 rounded-lg">
                                        <h3 class="font-bold text-lg mb-4">الأنواع</h3>
                                        <div class="flex flex-wrap gap-2">
                                            ${details.genres.map(genre => `
                                                <span class="genre-tag">${genre.name}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Recommendations -->
                        ${recommendations.results.length > 0 ? `
                            <section class="mt-12">
                                <h2 class="text-2xl font-bold mb-6">أعمال مشابهة</h2>
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    ${recommendations.results.slice(0, 12).map(item => `
                                        <div class="content-card cursor-pointer" onclick="window.location.href='details.html?id=${item.id}&type=${type}'">
                                            <div class="poster-container relative group">
                                                <img src="${item.poster_path ? this.IMG_URL + item.poster_path : './images/placeholder.jpg'}" 
                                                     alt="${item.title || item.name}" 
                                                     class="w-full h-full object-cover">
                                                <div class="overlay absolute inset-0 bg-black/70 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <div class="text-center text-white p-2">
                                                        <h4 class="font-semibold text-sm mb-1">${item.title || item.name}</h4>
                                                        <div class="flex items-center justify-center gap-1 text-yellow-400 text-xs">
                                                            <i data-lucide="star" class="w-3 h-3 fill-current"></i>
                                                            <span>${item.vote_average ? item.vote_average.toFixed(1) : 'N/A'}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </section>
                        ` : ''}
                    </div>
                `;

                lucide.createIcons();
                this.setupDetailEventListeners();
            }

            setupDetailEventListeners() {
                // Rating stars interaction
                const ratingStars = document.querySelectorAll('.rating-star');
                ratingStars.forEach(star => {
                    star.addEventListener('mouseover', () => {
                        const value = parseInt(star.dataset.value);
                        this.highlightStars(value);
                    });
                });

                // Reset stars on mouse leave
                const ratingContainer = document.querySelector('.rating-stars');
                if (ratingContainer) {
                    ratingContainer.addEventListener('mouseleave', () => {
                        this.highlightStars(this.currentRating || 0);
                    });
                }
            }

            highlightStars(rating) {
                const stars = document.querySelectorAll('.rating-star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('fill-current');
                    } else {
                        star.classList.remove('fill-current');
                    }
                });
            }

            setRating(rating) {
                this.currentRating = rating;
                this.highlightStars(rating);
            }

            submitReview(event, movieId) {
                event.preventDefault();
                
                if (!this.user) {
                    window.location.href = 'login.html';
                    return;
                }

                if (!this.currentRating) {
                    alert('يرجى اختيار تقييم');
                    return;
                }

                const reviewText = document.getElementById('review-text').value.trim();
                
                this.reviews[movieId] = {
                    rating: this.currentRating,
                    text: reviewText,
                    date: new Date().toISOString()
                };

                this.saveUserData();
                this.loadMovieDetails(); // Refresh the page
            }

            deleteReview(movieId) {
                if (confirm('هل أنت متأكد من حذف التقييم؟')) {
                    delete this.reviews[movieId];
                    this.saveUserData();
                    this.loadMovieDetails(); // Refresh the page
                }
            }

            async toggleFavorite(id, type) {
                if (!this.user) {
                    window.location.href = 'login.html';
                    return;
                }

                const existingIndex = this.favorites.findIndex(fav => fav.id === id);
                
                if (existingIndex > -1) {
                    this.favorites.splice(existingIndex, 1);
                } else {
                    const item = await this.fetchFromTMDB(`${type}/${id}`);
                    if (item) {
                        item.media_type = type;
                        this.favorites.push(item);
                    }
                }
                
                this.saveUserData();
                this.loadMovieDetails(); // Refresh to update button state
            }

            async toggleWatchlist(id, type) {
                if (!this.user) {
                    window.location.href = 'login.html';
                    return;
                }

                const existingIndex = this.watchlist.findIndex(item => item.id === id);
                
                if (existingIndex > -1) {
                    this.watchlist.splice(existingIndex, 1);
                } else {
                    const item = await this.fetchFromTMDB(`${type}/${id}`);
                    if (item) {
                        item.media_type = type;
                        this.watchlist.push(item);
                    }
                }
                
                this.saveUserData();
                this.loadMovieDetails(); // Refresh to update button state
            }

            playTrailer(key) {
                const trailerModal = document.createElement('div');
                trailerModal.className = 'fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4 trailer-modal';
                trailerModal.innerHTML = `
                    <div class="relative w-full max-w-5xl bg-black rounded-lg shadow-xl">
                        <div class="aspect-video">
                            <iframe class="w-full h-full" 
                                    src="https://www.youtube.com/embed/${key}?autoplay=1&enablejsapi=1" 
                                    title="YouTube video player" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="absolute top-4 right-4 text-white hover:text-primary">
                            <i data-lucide="x" class="w-8 h-8"></i>
                        </button>
                    </div>
                `;
                document.body.appendChild(trailerModal);
                lucide.createIcons();
            }

            shareContent(title) {
                if (navigator.share) {
                    navigator.share({
                        title: title,
                        text: `شاهد ${title} على PrimeVision`,
                        url: window.location.href,
                    });
                } else {
                    // Fallback - copy to clipboard
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        alert('تم نسخ الرابط');
                    });
                }
            }

            saveUserData() {
                if (this.user) {
                    const userData = {
                        user: this.user,
                        favorites: this.favorites,
                        watchlist: this.watchlist,
                        reviews: this.reviews,
                    };
                    localStorage.setItem('primevision_user', JSON.stringify(userData));
                }
            }

            showLoading() {
                const contentArea = document.getElementById('content-area');
                contentArea.innerHTML = `
                    <div class="text-center py-16">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-muted">جاري تحميل التفاصيل...</p>
                    </div>
                `;
            }

            showError(message) {
                const contentArea = document.getElementById('content-area');
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto mb-4 text-red-400"></i>
                        <h2 class="text-2xl font-bold mb-2">حدث خطأ</h2>
                        <p class="text-muted mb-6">${message}</p>
                        <button onclick="history.back()" class="btn-primary">العودة</button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // Initialize details page
        let detailsPage;
        document.addEventListener('DOMContentLoaded', () => {
            // Apply theme
            const savedTheme = localStorage.getItem('primevision_theme') || 'dark';
            document.documentElement.className = savedTheme;
            
            detailsPage = new DetailsPage();
            lucide.createIcons();
        });
    </script>
</body>
</html>
